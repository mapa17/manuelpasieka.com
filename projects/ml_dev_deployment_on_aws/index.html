<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Deploying a Machine Learning development environment in less than 5 minutes"><meta itemprop=description content="In this blog post, you are going to learn, how to deploy an AWS instance with a python Machine Learning development environment using Terraform. So you will be able to deploy your next cloud based Machine Learning environment in less than 5 minutes.
All scripts used in this tutorial are available on github as part of the onomatico project.
Pre-Requisites To be able to use what you learned in this tutorial, and run the Terraform script provided, you need the following."><meta itemprop=datePublished content="2022-04-21T00:00:00+00:00"><meta itemprop=dateModified content="2022-04-21T00:00:00+00:00"><meta itemprop=wordCount content="2549"><meta itemprop=keywords content><meta property="og:title" content="Deploying a Machine Learning development environment in less than 5 minutes"><meta property="og:description" content="In this blog post, you are going to learn, how to deploy an AWS instance with a python Machine Learning development environment using Terraform. So you will be able to deploy your next cloud based Machine Learning environment in less than 5 minutes.
All scripts used in this tutorial are available on github as part of the onomatico project.
Pre-Requisites To be able to use what you learned in this tutorial, and run the Terraform script provided, you need the following."><meta property="og:type" content="article"><meta property="og:url" content="https://www.manuelpasieka.com/projects/ml_dev_deployment_on_aws/"><meta property="article:section" content="projects"><meta property="article:published_time" content="2022-04-21T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-21T00:00:00+00:00"><meta property="og:site_name" content="Manuel Pasieka"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploying a Machine Learning development environment in less than 5 minutes"><meta name=twitter:description content="In this blog post, you are going to learn, how to deploy an AWS instance with a python Machine Learning development environment using Terraform. So you will be able to deploy your next cloud based Machine Learning environment in less than 5 minutes.
All scripts used in this tutorial are available on github as part of the onomatico project.
Pre-Requisites To be able to use what you learned in this tutorial, and run the Terraform script provided, you need the following."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Deploying a Machine Learning development environment in less than 5 minutes</title><link rel=stylesheet href=https://www.manuelpasieka.com/css/style.min.60545940dc68bc77005f62ee292cbffcba0be595532826a26a245b63372af945.css integrity="sha256-YFRZQNxovHcAX2LuKSy//LoL5ZVTKCaiaiRbYzcq+UU=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><img src=/img/Logo_cutout.png height=28 style=position:relative;top:7px>
<a href=https://www.manuelpasieka.com>Manuel Pasieka</a></div><nav class="site-nav hide-in-mobile"><a href=https://www.manuelpasieka.com/services/>Dienstleistungen</a>
<a href=https://www.manuelpasieka.com/projects/>Projekte</a>
<a href=https://www.manuelpasieka.com/aaip/>Austrian Ai Podcast</a>
<a href=https://www.manuelpasieka.com/about-me/>Über mich</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://linkedin.com/in/manuelpasieka target=_blank rel="noopener me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=https://github.com/mapa17 target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menü><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://www.manuelpasieka.com/services/>Dienstleistungen</a></li><li><a href=https://www.manuelpasieka.com/projects/>Projekte</a></li><li><a href=https://www.manuelpasieka.com/aaip/>Austrian Ai Podcast</a></li><li><a href=https://www.manuelpasieka.com/about-me/>Über mich</a></li></ul></div><main class="site-main section-inner thin animated fadeIn faster"><h1>Deploying a Machine Learning development environment in less than 5 minutes</h1><div class=content><p>In this blog post, you are going to learn, how to deploy an AWS instance
with a python Machine Learning development environment using <a href=https://www.terraform.io/intro>Terraform</a>.
So you will be able to deploy your next cloud based Machine Learning environment in less than 5 minutes.</p><p>All scripts used in this tutorial are available on github as part of the <a href=https://github.com/mapa17/onomatico>onomatico</a> project.</p><h2 id=pre-requisites>Pre-Requisites<a href=#pre-requisites class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>To be able to use what you learned in this tutorial, and run the Terraform script provided, you need
the following.</p><ul><li><p>AWS account and user credentials: You can create an AWS user for free <a href=https://portal.aws.amazon.com/billing/signup>here</a> and in addition, you need to have a private/public key pair that is associated with your AWS user. On <a href=https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key>how to create key pairs look</a> and how to <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/create-key-pairs.html#how-to-generate-your-own-key-and-import-it-to-aws>associate it with your AWS user</a>. <strong>Note: If you want to run p2.xlarge instances make sure that you have increased your quota to at least 4. See <a href=https://aws.amazon.com/de/premiumsupport/knowledge-center/ec2-on-demand-instance-vcpu-increase/>How to increase vCPU limits</a></strong></p></li><li><p><strong>Conda Environment</strong>: I highly recommend using a virtual environment like conda to install all tools and libraries that you are working with. Get miniconda installation for your platform <a href=https://docs.conda.io/en/latest/miniconda.html>here</a></p></li><li><p><strong>Local Terraform Installation</strong>: In your virtual conda environment install terraform from the conda-forge repo with <code>conda install -c conda-forge terraform</code></p></li><li><p><strong>Example project</strong>: The example project that contains the terraform and other scripts you can with git directly (install with conda if you should not have git). <code>git clone https://github.com/mapa17/onomatico.git</code></p></li></ul><h2 id=overview>Overview<a href=#overview class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Modern Infrastructure management is relying heavily on the concept of <a href=https://stackify.com/what-is-infrastructure-as-code-how-it-works-best-practices-tutorials/>infrastructure as code</a> and its tooling. In our case, we are going to make use of <a href=https://www.terraform.io/intro>Terraform</a> as an &ldquo;infrastructure as code&rdquo; software framework.</p><p>This means that we use a terraform script (part of the example project in <a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/aws_instance.tf>onomatico/deployment/aws_instance.tf</a>) to defines what infrastructure (i.e. instance) we want to create on AWS.</p><p>To configure that instance we are going to use a bash script <a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/setup_instance.sh>onomatico/deployment/setup_instance.sh</a> that is executed on the remote instance and is preparing a conda environment and installs the base requirements for our example project.</p><p>Now the overall picture is clear, let&rsquo;s dive into the details.</p><h2 id=choosing-the-right-cloud-instance>Choosing the right cloud instance<a href=#choosing-the-right-cloud-instance class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>In this tutorial, we are making use of AWS EC2 as the cloud provider of our choice. But don&rsquo;t worry if you are afraid to be vendor locked, as one of the benefits of a platform like Terraform is its multi-cloud capability, meaning that one can deploy and manage infrastructure on different cloud providers by, in the best case, only adapting some of your terraform scripts slightly.</p><p>Something that Terraform does not do for you, is to select the best <strong>instance type</strong> and <strong>AMI</strong> (i.e. system image) for your project.
The instance type should be selected based on the requirement of computing capacity, memory, and if a GPU is needed or not.
As this tutorial has the goal to provide you with a Machine Learning development environment, I opted for an <a href=https://aws.amazon.com/ec2/instance-types/p2/>p2.xlarge</a> that comes with 62 gB Memory, 4 vCPU&rsquo;s and a GPU (Nvidia Tesla K80). An alternative instance type is a stronger but as well more expansive p3.2xlarge instance.</p><p>I highly recommend checking <a href=https://instances.vantage.sh/>instances.vantage.sh</a> to compare different instances and their configurations as well as to get an estimate of their costs.</p><p>Once you selected the instance type of your choice you have to decide on the system image that will be used on the new instance. As part of this tutorial, I chose Amazons own <a href=https://docs.aws.amazon.com/dlami/latest/devguide/what-is-dlami.html>AWS Deep Learning AMI</a> that comes pre-installed with an AWS optimized linux installation, and the nvidia drivers (CUDA) so ML Frameworks like tensorflow or pytorch can make use of GPU acceleration.</p><p>There is unfortunately no simple way to identify the AMI ID one needs to select the correct system image. I recommend going to the AWS web console and using AMI Catalog which is part of the EC2 web interface and searching for &ldquo;Deep Learning Base AMI (Amazon Linux 2)&rdquo; (the AMI ID is part of the description).</p><h2 id=defining-and-using-the-terraform-configuration>Defining and using the Terraform configuration<a href=#defining-and-using-the-terraform-configuration class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>We define the instance and how it should be configured using the following Terraform configuration file (<a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/setup_instance.sh>onomatico/deployment/setup_instance.sh</a>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>################################ User variables ################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Path to private and public key used with AWS</span>
</span></span><span class=line><span class=cl><span class=n>variable</span> <span class=s2>&#34;prv_key_path&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>default</span> <span class=o>=</span> <span class=s2>&#34;~/.ssh/aws_dev&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>variable</span> <span class=s2>&#34;pub_key_path&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>default</span> <span class=o>=</span> <span class=s2>&#34;~/.ssh/aws_dev.pub&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AWS Instance type that should be deployed</span>
</span></span><span class=line><span class=cl><span class=n>variable</span> <span class=s2>&#34;instance_type&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>#default = &#34;p2.xlarge&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>default</span> <span class=o>=</span> <span class=s2>&#34;t2.small&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AWS AMI Image ID</span>
</span></span><span class=line><span class=cl><span class=n>variable</span> <span class=s2>&#34;ami&#34;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>default</span> <span class=o>=</span> <span class=s2>&#34;ami-0b879110efb09396b&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AWS Region we want the instance to run in</span>
</span></span><span class=line><span class=cl><span class=n>provider</span> <span class=s2>&#34;aws&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>region</span> <span class=o>=</span> <span class=s2>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>########################### Terraform Configuration ############################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>required_version</span> <span class=o>=</span> <span class=s2>&#34;&gt;= 1.0.7&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>resource</span> <span class=s2>&#34;aws_key_pair&#34;</span> <span class=s2>&#34;pub-key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>key_name</span>   <span class=o>=</span> <span class=s2>&#34;pub-key&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>public_key</span> <span class=o>=</span> <span class=n>file</span><span class=p>(</span><span class=s2>&#34;$</span><span class=si>{var.pub_key_path}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define an AWS instance using the usr variables from above</span>
</span></span><span class=line><span class=cl><span class=c1># Make user of the user_data (ie.e cloud init) option to define a bash script</span>
</span></span><span class=line><span class=cl><span class=c1># to configure the instance at the first boot</span>
</span></span><span class=line><span class=cl><span class=n>resource</span> <span class=s2>&#34;aws_instance&#34;</span> <span class=s2>&#34;instance&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>ami</span>                         <span class=o>=</span> <span class=s2>&#34;$</span><span class=si>{var.ami}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>instance_type</span>               <span class=o>=</span> <span class=s2>&#34;$</span><span class=si>{var.instance_type}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>key_name</span>                    <span class=o>=</span> <span class=n>aws_key_pair</span><span class=o>.</span><span class=n>pub</span><span class=o>-</span><span class=n>key</span><span class=o>.</span><span class=n>id</span>
</span></span><span class=line><span class=cl>  <span class=n>vpc_security_group_ids</span>      <span class=o>=</span> <span class=p>[</span><span class=n>aws_security_group</span><span class=o>.</span><span class=n>sg</span><span class=o>.</span><span class=n>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=n>associate_public_ip_address</span> <span class=o>=</span> <span class=n>true</span>
</span></span><span class=line><span class=cl>  <span class=n>user_data</span> <span class=o>=</span> <span class=s2>&#34;${file(&#34;</span><span class=n>setup_instance</span><span class=o>.</span><span class=n>sh</span><span class=s2>&#34;)}&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>root_block_device</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>volume_size</span>           <span class=o>=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>    <span class=n>delete_on_termination</span> <span class=o>=</span> <span class=n>true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>tags</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span> <span class=o>=</span> <span class=s2>&#34;AWS_ML_Instance&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Our user_data script will be executed as part of cloud-init final</span>
</span></span><span class=line><span class=cl><span class=c1># Block terraform until cloud-init has finished executing our script and the instance is ready.</span>
</span></span><span class=line><span class=cl><span class=c1># Create a special null_resource that will use remote-exec to wait until cloud-init has finished</span>
</span></span><span class=line><span class=cl><span class=n>resource</span> <span class=s2>&#34;null_resource&#34;</span> <span class=s2>&#34;cloud_init_wait&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>connection</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span>        <span class=o>=</span> <span class=s2>&#34;$</span><span class=si>{aws_instance.instance.public_ip}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span>        <span class=o>=</span> <span class=s2>&#34;ec2-user&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>private_key</span> <span class=o>=</span> <span class=s2>&#34;${file(&#34;</span><span class=err>$</span><span class=p>{</span><span class=n>var</span><span class=o>.</span><span class=n>prv_key_path</span><span class=p>}</span><span class=s2>&#34;)}&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#script_path = &#34;/tmp/cloud_init_wait.sh&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span>     <span class=o>=</span> <span class=s2>&#34;10m&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>provisioner</span> <span class=s2>&#34;remote-exec&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>inline</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;sudo cloud-init status --wait&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>depends_on</span> <span class=o>=</span> <span class=p>[</span><span class=n>aws_instance</span><span class=o>.</span><span class=n>instance</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define a basic security group that restricts inbound access to ssh but allows</span>
</span></span><span class=line><span class=cl><span class=c1># all outgoing access</span>
</span></span><span class=line><span class=cl><span class=n>resource</span> <span class=s2>&#34;aws_security_group&#34;</span> <span class=s2>&#34;sg&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span>        <span class=o>=</span> <span class=s2>&#34;my_security_group&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;Only allow inbound ssh access&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ingress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>from_port</span>   <span class=o>=</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl>    <span class=n>to_port</span>     <span class=o>=</span> <span class=mi>22</span>
</span></span><span class=line><span class=cl>    <span class=n>protocol</span>    <span class=o>=</span> <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>egress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>from_port</span>   <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>to_port</span>     <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>protocol</span>    <span class=o>=</span> <span class=s2>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cidr_blocks</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>tags</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Name</span> <span class=o>=</span> <span class=s2>&#34;AWS_ML_DEV_INSTANCE&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># On termination of the script set an output varialbe containing the public ip</span>
</span></span><span class=line><span class=cl><span class=c1># of the instance so we can access it using ssh</span>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=s2>&#34;instance-public-ip&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>value</span> <span class=o>=</span> <span class=n>aws_instance</span><span class=o>.</span><span class=n>instance</span><span class=o>.</span><span class=n>public_ip</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The configuration has the following main parts:</p><ul><li><strong>User variables</strong> that one can use to adjust the script for its use with a new project</li><li><strong>AWS Instance</strong> configuration that applies the user variables to define the instance</li><li>a <strong>dummy terraform resource provider</strong> that will take care to block the terraform deployment while <strong>cloud init</strong> is used to prepare the instance</li><li>a simple <strong>aws security group</strong> that restricts access to the machine for security reasons</li></ul><p>To use the script you needs to apply the following commands</p><ul><li><code>terraform init</code>: Running init in the project directory where the configuration is located will create several (hidden) folders and files that terraform uses to build a deployment plan for your configuration and keep track of the executed configurations to be able to tear them down after you don&rsquo;t need them anymore.</li><li><code>terraform plan</code>: will launch the deployment planning process that will read your configurations (all files with the extension .tf), analyze them and create a deployment plan with the desired state that terraform will try to achieve. You can store this plan and execute it later for reproducibility.</li><li><code>terraform apply</code>: is creating a plan if none exists and will execute it, accomplishing the actual creation of instances and resources.</li><li><code>terraform destroy</code>: will remove any running instances and resources defined in your configuration.</li></ul><p>But before you can use terraform, you have to provide it with essential AWS credentials through environment variables.</p><p>In particular your <a href=https://docs.aws.amazon.com/powershell/latest/userguide/pstools-appendix-sign-up.html>AWS Access and Secret key</a> that you can expose to Terraform through the following environment variables by executing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AWS_ACCESS_KEY_ID</span><span class=o>=</span>AKIAXXXXXXXXXXXX
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AWS_SECRET_ACCESS_KEY</span><span class=o>=</span>XXXXXXXXXXXX
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AWS_DEFAULT_REGION</span><span class=o>=</span>eu-central-1
</span></span></code></pre></div><p>The last thing that is missing is the location of your public and private key pair that is associated with your AWS user (ie. the user that is specified in the AWS access and secret key with the permissions to create instances and connect to them). To do so, you can use the two user variables <strong>prv_key_path</strong> and <strong>pub_key_path</strong> at the top of the Terraform configuration file.</p><h2 id=configuring-the-cloud-instance-for-an-ml-project>Configuring the cloud instance for an ML Project<a href=#configuring-the-cloud-instance-for-an-ml-project class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>After Terraform has created the AWS instance it runs the select AMI image. In our case is an AWS optimized Linux installation with the Nvidia drivers and libraries (i.e. Cuda) to support GPU hardware acceleration, but nothing more.</p><p>To be able to use this instance as an ML development machine we need our ML libraries and tooling installed. As always I recommend conda + pip as the virtual environment and package management systems of your choice.</p><p>To automatize this part of the system configuration I have created a bash script (i.e. <a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/setup_instance.sh>onomatico/deployment/setup_instance.sh</a>) that will download miniconda, install a conda environment with the name <code>mldev</code>, will git clone our experiment project, and will install all its dependencies.</p><p>Once this is done, you can ssh into the instance, activate the conda environment (with <code>conda activate mldev</code>), and enjoy a Pytorch development environment with GPU support and many of the most common ML libraries.</p><p>Let&rsquo;s have a quick look at that setup script <a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/setup_instance.sh>onomatico/deployment/setup_instance.sh</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># Note: aws cloud-init requires the shebang to be `#!/bin/sh` nothing else will work!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>################################### User Settings ##############################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define user variables </span>
</span></span><span class=line><span class=cl><span class=nv>USER</span><span class=o>=</span><span class=s2>&#34;ec2-user&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>HOME</span><span class=o>=</span><span class=s2>&#34;/home/ec2-user&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CONDA</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2>/miniconda3/bin/conda&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CONDA_ACTIVATE</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2>/miniconda3/bin/activate&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PROJECT</span><span class=o>=</span><span class=s2>&#34;https://github.com/mapa17/onomatico.git&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PROJECT_HOME</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2>/onomatico&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>################################### Logging ####################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a log message that will be visible in /var/log/cloud-init-output.log to verify the exeuction of this script</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;## Executing instance configuration script!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Terminate script on any error</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Log all output to file</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> &gt; /tmp/setup_instance.log                                                                      
</span></span><span class=line><span class=cl><span class=nb>exec</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>######################## Setup conda and project dependencies ##################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Download miniconda</span>
</span></span><span class=line><span class=cl>curl -L https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o /tmp/miniconda.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Install as ec2-user miniconda in batch mode</span>
</span></span><span class=line><span class=cl>sudo -u <span class=si>${</span><span class=nv>USER</span><span class=si>}</span> -- bash -c <span class=s2>&#34;cd </span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2> &amp;&amp; echo -n &#39;Running as &#39; &amp;&amp; who &amp;&amp; bash /tmp/miniconda.sh -b &amp;&amp; </span><span class=si>${</span><span class=nv>CONDA</span><span class=si>}</span><span class=s2> init bash&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create env with support for poetry (will download a lot of other stuff)</span>
</span></span><span class=line><span class=cl>sudo -u <span class=si>${</span><span class=nv>USER</span><span class=si>}</span> -- bash -c <span class=s2>&#34;cd </span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2> &amp;&amp; </span><span class=si>${</span><span class=nv>CONDA</span><span class=si>}</span><span class=s2> create -n mldev poetry -y&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Clone the repo and install dependencies</span>
</span></span><span class=line><span class=cl>sudo -u <span class=si>${</span><span class=nv>USER</span><span class=si>}</span> -- bash -c <span class=s2>&#34;cd </span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2> &amp;&amp; source </span><span class=si>${</span><span class=nv>CONDA_ACTIVATE</span><span class=si>}</span><span class=s2> mldev &amp;&amp; git clone </span><span class=si>${</span><span class=nv>PROJECT</span><span class=si>}</span><span class=s2> </span><span class=si>${</span><span class=nv>PROJECT_HOME</span><span class=si>}</span><span class=s2> &amp;&amp; cd </span><span class=si>${</span><span class=nv>PROJECT_HOME</span><span class=si>}</span><span class=s2> &amp;&amp; poetry install&#34;</span> 
</span></span></code></pre></div><p>Similar to the Terraform configuration it starts with a bunch of project-specific user settings, like the path to the github repository containing our project and some AWS specific settings like the username and home directory of the default user.</p><p>Next are some settings that will make sure to log all output created from this script to be written to <code>/tmp/setup_instance.log</code> for debugging in case of errors. To detect problems easier, we let this script stop and fail as soon as any single command fails, by setting <code>set -e</code>.</p><p>The last part of the script is executing a series of shell commands that download, install and configure conda, plus the project and its dependencies. We make sure to run those commands as a normal user, as the script itself is executed by cloud-init as root.</p><h2 id=making-sure-that-terraform-waits-for-the-instance-to-complete-its-setup>Making sure that terraform waits for the instance to complete its setup<a href=#making-sure-that-terraform-waits-for-the-instance-to-complete-its-setup class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>The bash script that we use to configure the newly created instance is executed through AWS <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html>cloud-init</a>
by specifying the content of the script as the parameter <code>user_data</code> in the AWS instance configuration in Terraform.</p><p>This will cause the creation of a bash script on the new instance and it&rsquo;s executing as part of <code>clout-init final</code>. Unfortunately, the execution of this step can take place quite some time, as the first time the instance boots cloud-init is executing besides our script, several other AWS pre-configured system updates. Terraform on the other hand does not wait for cloud-init nor has it means to monitor its progress. Instead, Terraform will simply create the instance and provide the script to cloud-init, assuming its job is done.</p><p>To make sure that <code>terraform apply</code> will only terminate once cloud-init has finished, we introduce a <a href=https://www.terraform.io/language/resources/provisioners/remote-exec>remove-exec terraform provider</a> named <code>cloud_init_wait</code> that is using ssh on the remote instance and is executing <code>sudo cloud-init status --wait</code> which blocks until cloud-init finishes its execution.</p><p>Once this modified Terraform configuration terminates executing, we know that the machine is ready and we can access it through ssh ourselves. The <code>public ip</code> of our newly created instance is contained at the end of the output generated with <code>terraform apply</code>.</p><p>Example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>% terraform apply 
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: .
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: status: <span class=k>done</span>
</span></span><span class=line><span class=cl>null_resource.cloud_init_wait: Creation <span class=nb>complete</span> after 4m46s <span class=o>[</span><span class=nv>id</span><span class=o>=</span>527681618375576572<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Apply complete! Resources: <span class=m>4</span> added, <span class=m>0</span> changed, <span class=m>0</span> destroyed.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>instance-public-ip <span class=o>=</span> <span class=s2>&#34;3.67.40.126&#34;</span>
</span></span></code></pre></div><p>You can then, access the machine with the default AWS user and your private ssh key</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh -i ~/.ssh/aws_dev ec2-user@3.67.40.126
</span></span></code></pre></div><h2 id=how-to-resolve-errors-on-the-way>How to resolve errors on the way<a href=#how-to-resolve-errors-on-the-way class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>The infrastructure automation you learned in this tutorial has two main sources of possible errors.</p><p>The Terraform configuration and the bash script that is used to configure the project environment.</p><p>Terraform will do its best to inform you about errors in your configuration when you execute <code>terraform plan</code> and if you don&rsquo;t wander too far away from the provided template you should be fine. Besides googling for a particular error message (always the best and hopefully your first approach) the official <a href=https://www.terraform.io/intro>Terraform documentation</a> is your best source of information about the Terraform API and details about different configuration parameters.</p><p>Far more difficult to identify are errors in the system configuration and the execution of the bash script. Any errors that happen during the executing with cloud-init will cause Terraform to quit with a rather cryptic error message similar to the following</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>null_resource.cloud_init_wait <span class=o>(</span>remote-exec<span class=o>)</span>: status: error
</span></span><span class=line><span class=cl>╷
</span></span><span class=line><span class=cl>│ Error: remote-exec provisioner error
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>│   with null_resource.cloud_init_wait,
</span></span><span class=line><span class=cl>│   on aws_instance.tf line 64, in resource <span class=s2>&#34;null_resource&#34;</span> <span class=s2>&#34;cloud_init_wait&#34;</span>:
</span></span><span class=line><span class=cl>│   64:   provisioner <span class=s2>&#34;remote-exec&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>│ error executing <span class=s2>&#34;/tmp/terraform_823990194.sh&#34;</span>: Process exited with status <span class=m>1</span>
</span></span></code></pre></div><p>If this is the case, you have to manually investigate the cloud init log files on the new instance in <code>/var/log/cloud-init-output.log</code> or the script log that is written to <code>/tmp/setup_instance.log</code>.</p><h2 id=where-to-go-from-here>Where to go from here<a href=#where-to-go-from-here class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Congratulations! You have now, an AWS instance running and configured and can go ahead to develop some amazing new AI-powered applications!</p><p>Obviously, you want to take the scripts shown here as a template for your own projects. Doing so you should reflect and if necessary adjust the following configuration settings</p><ul><li>instance type (<a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/aws_instance.tf>onomatico/deployment/aws_instance.tf</a>)</li><li>AMI image (<a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/aws_instance.tf>onomatico/deployment/aws_instance.tf</a>)</li><li>git project repository (<a href=https://github.com/mapa17/onomatico/blob/17519ca4f11667a4251f21746e10f99fd2cec253/deployment/setup_instance.sh>onomatico/deployment/setup_instance.sh</a>)</li></ul><p>Good luck!</p><h2 id=where-not-to-go-from-here>Where not to go from here<a href=#where-not-to-go-from-here class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>The goal of this tutorial is to provide you with a template to use for quick deployment of a new ML development environment in the cloud.</p><p>It&rsquo;s not intended to be used for the deployment of production infrastructure or to build an ML workflow that would be launching instances, training models, and doing testing or prediction automatically.</p><p>You can build all those nice things by yourself and make use of Terraform to manage your cloud infrastructure, but first I would recommend you to have a look at tools like <a href=https://www.kubeflow.org/docs/started/introduction/>KubeFlow</a> for your ML Pipelines.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>With this tutorial, you have hopefully reached a basic understanding of how to use Tools like Conda, Terraform, and AWS EC2 as well as a Template to start your next ML development project on an AWS instance.</p><p>If you have some questions or comments write me at <a href=mailto:contact@manuelpasieka.com>contact@manuelpasieka.com</a></p></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://www.manuelpasieka.com>Manuel Pasieka</a></p></footer><script src=https://www.manuelpasieka.com/js/bundle.min.c11908c4b7cc57cc34cf88d4f5f7a9c8b7a5dd84657d390d8f2143d71524f0f0.js integrity="sha256-wRkIxLfMV8w0z4jU9fepyLel3YRlfTkNjyFD1xUk8PA=" crossorigin=anonymous></script></body></html>